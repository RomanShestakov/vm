---
# base.yml - play to install a VM
- name: base.yml
  hosts: all

  # pre_tasks:
  #   - name: Ensure the locale exists
  #     locale_gen:
  #       name: en_US.UTF-8
  #       state: present
  #   - name: set as default locale
  #     command: localectl set-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

  roles:
    - role: RomanShestakov.ansible-environment
      become: yes
      vars:
        environment_config:
          LANG: en_US.UTF-8
          LC_ALL: en_US.UTF-8

    - role: geerlingguy.git
      become: yes
      git_install_from_source: true
      git_install_path: "/usr"
      git_install_from_source_force_update: true
      git_version: "2.22.0"
      tags: ["git"]

    - role: ANXS.build-essential
      become: yes
      tags: ["build-essensial"]

    - role: RomanShestakov.ansible-role-common-tools
      become: yes
      tags: ["build-common"]

    - role: RomanShestakov.ansible-role-cmake
      cmake_version: 3.22.1
      tags: ["cmake"]

    - role: RomanShestakov.ansible-role-gcc
      gcc_version: 8.2.0
      binutils_version: 2.31
      gdb_version: 8.2
      tags: ["gcc"]

    - role: RomanShestakov.ansible-role-llvm
      become: yes
      version: llvmorg-12-init
      gcc_version: 8.2.0
      tags: ["llvm"]

    - role: RomanShestakov.ansible-role-dotfiles
      dotfiles_repo_url: "https://github.com/RomanShestakov/dotfiles.git"
      dotfiles_dest: "/home/vagrant"

    - role: RomanShestakov.ansible-role-tmux
      become: yes
      tags: ["tmux"]

    - role: RomanShestakov.ansible-role-emacs
      become: yes
      emacs_version: "emacs-27.1"
      tags: ["emacs"]

    - role: RomanShestakov.ansible-role-valgrind
      become: yes
      tags: ["valgrind"]

    - role: RomanShestakov.ansible-role-protobuf
      gcc_version: 8.2.0
      become: yes
      tags: ["protobuf"]

    - role: RomanShestakov.ansible-role-antrl
      tags: ["antrl"]

    - role: geerlingguy.java
      become: yes
      java_home: "/opt/java"
      java_packages:
        - java-1.8.0-openjdk
        - java-1.8.0-openjdk-devel

    - role: RomanShestakov.ansible-role-python
      vars:
        python_version: 3.9.8
        make_num_threads: 1
        python_path: "/opt/python{{ python_version[:3] }}"
      tags: ["python"]


  post_tasks:

    - name: PythonEnv | copy requirements.txt
      become: yes
      ansible.builtin.copy:
        src: requirements.txt
        dest: /home/vagrant

    - name: PythonEnv | Venv setup
      become: yes
      shell:
        cmd: /opt/python{{ python_version[:3] }}/bin/python3.9 -m pip install -r /home/vagrant/requirements.txt --user

    - name: .EMACS | get .emacs git repository
      become: yes
      become_user: vagrant
      git: repo="https://github.com/RomanShestakov/.emacs.d.git" dest="/home/vagrant/.emacs.d" accept_hostkey=yes force=yes

    - name: Create a directory to write mem dumps, if it does not exist
      file:
        path: /tmp/cores
        state: directory
        mode: '0777'

    - name: Set kernel.core_pattern in sysctl
      become: yes
      sysctl:
        name: kernel.core_pattern
        value: "/tmp/cores/core.%e.%p.%h.%"
        state: present
        reload: yes
...
